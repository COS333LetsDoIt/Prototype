from __future__ import print_function
from django.shortcuts import render, get_object_or_404
from django.core.urlresolvers import reverse
from django.views.decorators.csrf import csrf_protect
from prototypeApp.models import Person, Group, Event, Image
from django import forms
from django.db import models
from django.forms import ModelForm
#from datetimewidget.widgets import DateTimeWidget
import datetime
from datetime import timedelta
import pytz
from django.http import HttpResponseRedirect
from django.contrib.auth.decorators import login_required
from django.contrib.auth import logout, views, authenticate, login
from django.contrib.auth.models import User
from django.core.context_processors import csrf
# pip install python-dateutil
import dateutil.parser
import re
import json

## imports for photo manipulation ##
from PIL import Image as Img
from io import StringIO
from django.core.files.uploadedfile import InMemoryUploadedFile

from django.core.mail import send_mail, BadHeaderError
from django.http import HttpResponse, HttpResponseRedirect
import time
 os.environ['DJANGO_SETTINGS_MODULE'] = 'prototype.settings'

interval_minutes = 10 
delay = 60*interval_minutes #60 seconds


def main():
	# Every "interval" minutes
	while True:
		event_list = Event.objects.all()
		
		for event in event_list:
			if (inSendInterval(event)):
				person_list = event.members.all()
				recepient_list = [person.user.email for person in person_list]
				send_mail(event.name + " is in 30 minutes!", 
					event.name + " is in 30 minutes!\nDescription: " +  
						event.description + 
						"\nLocation: " + event.location + 
						"\nTime: " + event.starttime + " to " + event.endtime, 
					"no_response@letsdoit.com",
					recepient_list, fail_silently=True)

		time.sleep(delay)

def inSendInterval(event):
	low = 30
	high = 40
	now = datetime.datetime.now()
	difference = event.starttime - now
	return ((difference.minutes > low) and (difference.minutes < high))

main()

